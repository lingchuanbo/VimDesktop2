# 按键提示自动隐藏功能说明

## 功能概述

VimD 现在支持配置按键提示的自动隐藏行为，让用户体验更加流畅和智能。

## 配置选项

在 `Custom/vimd.ini` 的 `[config]` 部分添加了以下配置选项：

```ini
; 按键提示自动隐藏配置
tooltip_auto_hide = 1
; 是否启用按键提示自动隐藏 (0=禁用, 1=启用)

tooltip_hide_on_mouse_leave = 1
; 鼠标离开提示区域时自动隐藏 (0=禁用, 1=启用)

tooltip_hide_on_click_outside = 1
; 点击提示区域外时自动隐藏 (0=禁用, 1=启用)

tooltip_hide_on_window_change = 1
; 切换到其他窗口时自动隐藏 (0=禁用, 1=启用)

tooltip_hide_timeout = 5000
; 无操作自动隐藏超时时间(毫秒) (0=禁用超时, 默认5000ms)
```

## 自动隐藏规则

### 1. 鼠标离开隐藏 (`tooltip_hide_on_mouse_leave`)
- 当鼠标移出提示框区域500ms后自动隐藏
- 提供了适当的边距，避免鼠标快速移动时误触发

### 2. 点击外部隐藏 (`tooltip_hide_on_click_outside`)
- 点击提示框区域外的任何位置时立即隐藏
- 支持左键和右键点击检测

### 3. 窗口切换隐藏 (`tooltip_hide_on_window_change`)
- 当前活动窗口发生变化时立即隐藏
- 确保在切换应用程序时提示不会残留

### 4. 超时隐藏 (`tooltip_hide_timeout`)
- 指定时间内无操作自动隐藏
- 设置为 0 表示禁用超时功能
- 默认 5000ms (5秒)

### 5. 按键缓存清除 (`tooltip_clear_key_cache_on_hide`)
- 自动隐藏时清除按键缓存，避免后续按键执行之前的组合功能
- 当用户按下组合键前缀后，如果提示自动隐藏，会清除按键缓存
- **示例**：在 Max3D 中按 `o` 键显示提示，切换窗口后提示隐藏并清除缓存，避免回到 Max3D 后按 `f` 键意外执行 `of` 功能
- 默认启用 (1)，不推荐禁用 (0)

### 6. 全局窗口监控 (`tooltip_global_window_monitor`)
- 启用全局窗口切换监控，即使没有提示显示时也会清除按键缓存
- 解决直接切换窗口而不触发提示隐藏时，按键缓存仍然保留的问题
- 与按键缓存清除功能配合使用，提供更完整的保护
- 默认启用 (1)，可以禁用 (0) 以减少资源占用

## 使用方法

### 基本使用
1. 修改 `Custom/vimd.ini` 中的配置选项
2. 重新加载 VimD 脚本
3. 按键提示将根据配置自动隐藏

### 测试功能
使用快捷键 `Ctrl+Alt+Shift+H` 可以测试自动隐藏功能：
- 显示当前配置状态
- 提供测试说明
- 可以实际体验各种隐藏条件

## 技术实现

### 新增类：ToolTipInfoManager
- 管理按键提示信息的显示和隐藏
- 支持配置的自动隐藏规则
- 提供鼠标和窗口状态监控

### 增强的 HideInfo() 函数
```ahk
HideInfo(force := false)
```
- `force` 参数：强制隐藏，忽略配置规则
- 向后兼容原有调用方式

### 监控机制
- **鼠标监控**：100ms 间隔检查鼠标位置和点击状态
- **窗口监控**：200ms 间隔检查活动窗口变化
- **超时监控**：使用 SetTimer 实现精确的超时控制

## 性能影响

- 监控功能仅在显示提示时启用
- 使用轻量级定时器，对系统性能影响极小
- 自动清理资源，避免内存泄漏

## 兼容性

- 完全向后兼容现有代码
- 不影响原有的 ToolTipManager 功能
- 支持 ToolTipOptions 和 BTT 两种提示库

## 故障排除

### 如果自动隐藏不工作：
1. 检查 `tooltip_auto_hide` 是否设置为 1
2. 确认配置文件语法正确
3. 重新加载脚本

### 如果隐藏太敏感：
1. 调整 `tooltip_hide_timeout` 增加超时时间
2. 禁用不需要的隐藏规则

### 如果隐藏太慢：
1. 减少 `tooltip_hide_timeout` 时间
2. 启用更多的隐藏规则

## 示例配置

### 保守配置（较少自动隐藏）
```ini
tooltip_auto_hide = 1
tooltip_hide_on_mouse_leave = 0
tooltip_hide_on_click_outside = 1
tooltip_hide_on_window_change = 1
tooltip_hide_timeout = 10000
tooltip_clear_key_cache_on_hide = 1
tooltip_global_window_monitor = 1
```

### 积极配置（更多自动隐藏）
```ini
tooltip_auto_hide = 1
tooltip_hide_on_mouse_leave = 1
tooltip_hide_on_click_outside = 1
tooltip_hide_on_window_change = 1
tooltip_hide_timeout = 3000
tooltip_clear_key_cache_on_hide = 1
tooltip_global_window_monitor = 1
```

### 禁用自动隐藏
```ini
tooltip_auto_hide = 0
```

### 保留按键缓存（不推荐）
```ini
tooltip_auto_hide = 1
tooltip_hide_on_mouse_leave = 1
tooltip_hide_on_click_outside = 1
tooltip_hide_on_window_change = 1
tooltip_hide_timeout = 5000
tooltip_clear_key_cache_on_hide = 0
tooltip_global_window_monitor = 0
```

## 更新日志

- **v2.2**: 添加全局窗口监控功能
- 新增全局窗口切换监控，即使没有提示显示时也会清除按键缓存
- 新增 `tooltip_global_window_monitor` 配置选项
- 解决直接切换窗口时按键缓存不被清除的问题
- **v2.1**: 添加按键缓存清除功能
- 自动隐藏时清除按键缓存，避免后续按键执行之前的组合功能
- 新增 `tooltip_clear_key_cache_on_hide` 配置选项
- **v2.0**: 添加按键提示自动隐藏功能
- 支持多种隐藏条件配置
- 新增 ToolTipInfoManager 类
- 增强 HideInfo() 函数
- 添加测试功能